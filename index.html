<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación de Desempeño - CNCI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para la aplicación */
        .gradient-bg {
            background: linear-gradient(135deg, #2a6aff 0%, #ff8500 100%);
        }
        .login-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .input-focus:focus {
            box-shadow: 0 0 0 3px rgba(42, 106, 255, 0.2);
        }
        .btn-primary {
            background-color: #2a6aff;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #1a5bff;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background-color: #ff8500;
             transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #f07d00;
            transform: translateY(-2px);
        }
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        /* Estilos para la barra de progreso */
        .progress-bar-container { background-color: #e9ecef; border-radius: 9999px; }
        .progress-bar {
            background: linear-gradient(90deg, #2a6aff, #5a8dff);
            transition: width 0.5s ease-in-out;
            border-radius: 9999px;
        }
        /* Estilos para el círculo de puntaje */
        .score-circle {
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white;
            flex-shrink: 0;
        }
        .score-high { background-color: #10b981; } /* Verde */
        .score-medium { background-color: #f59e0b; } /* Amarillo */
        .score-low { background-color: #ef4444; } /* Rojo */

        /* Para el icono de desplegar/colapsar */
        .criteria-toggle { transition: transform 0.3s ease; }
        .rotated { transform: rotate(180deg); }

        /* Estilos del SKELETON LOADER para una mejor UX */
        .skeleton {
            background-color: #e2e8f0;
            border-radius: 0.25rem;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }

        /* Ocultar scrollbar en el contenedor de modales */
        .modal-container::-webkit-scrollbar { display: none; }
        .modal-container { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Contenedor Principal de la App -->
    <div id="app" class="h-screen w-screen">

        <!-- Pantalla de Carga Inicial -->
        <div id="loadingScreen" class="w-full h-full flex flex-col items-center justify-center gradient-bg">
             <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="Logo CNCI" class="h-24 w-auto mb-4 fade-in">
            <h1 class="text-white text-2xl font-bold mb-2 fade-in" style="animation-delay: 0.2s;">Sistema de Evaluación de Desempeño</h1>
            <div class="w-16 h-16 border-4 border-t-transparent border-white rounded-full animate-spin mt-4 fade-in" style="animation-delay: 0.4s;"></div>
            <p id="loadingStatus" class="text-white mt-4 text-sm fade-in" style="animation-delay: 0.6s;">Conectando con Firebase...</p>
        </div>

        <!-- Pantalla de Login -->
        <div id="loginScreen" class="w-full h-full items-center justify-center p-4 gradient-bg hidden">
            <div class="w-full max-w-md mx-auto login-card rounded-2xl shadow-2xl p-8 border border-white/20 fade-in">
                <div class="text-center mb-6">
                    <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="Logo CNCI" class="mx-auto h-20 w-auto mb-4">
                    <h1 id="loginTitle" class="text-2xl font-bold text-gray-800">Evaluación Modular</h1>
                    <p id="loginSubtitle" class="text-gray-600 mt-1">Consulta tu desempeño ingresando tus credenciales.</p>
                </div>
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Usuario</label>
                        <input type="text" id="username" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 input-focus" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                        <input type="password" id="password" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 input-focus" required>
                    </div>
                    <div id="loginError" class="hidden text-red-600 text-sm text-center bg-red-100 p-2 rounded-lg"></div>
                    <button type="submit" id="loginButton" class="w-full btn-primary text-white font-semibold py-3 px-6 rounded-lg focus:outline-none flex items-center justify-center">
                        <span id="loginButtonText">Ingresar</span>
                        <div id="loginSpinner" class="hidden w-5 h-5 border-2 border-t-transparent border-white rounded-full animate-spin ml-2"></div>
                    </button>
                </form>
            </div>
        </div>

        <!-- Vista SUPERADMIN -->
        <div id="superAdminScreen" class="hidden h-screen flex flex-col">
            <!-- Header -->
            <header class="bg-white shadow-md p-4 flex justify-between items-center z-10 flex-shrink-0">
                <div class="flex items-center space-x-3">
                    <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="Logo CNCI" class="h-10 w-auto">
                    <h1 class="text-xl font-bold text-gray-800">👑 Panel de Superadministrador</h1>
                </div>
                <div class="flex items-center space-x-4">
                     <div id="superAdminSyncIndicator" class="text-xs text-gray-500 flex items-center space-x-1">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span>Sincronizado</span>
                    </div>
                    <span id="superAdminWelcome" class="text-sm font-medium text-gray-700"></span>
                    <button onclick="logout()" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Salir</button>
                </div>
            </header>
            <!-- Contenido -->
            <main class="flex-grow p-6 overflow-y-auto bg-gray-50">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Columna Izquierda -->
                    <div>
                        <!-- Gestión de Usuarios -->
                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold">Gestión de Usuarios</h2>
                                <button onclick="openUserModal()" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Añadir Usuario</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuario</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rol</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Supervisor</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Centro de Respaldo y Restauración -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h2 class="text-lg font-bold mb-4">Centro de Respaldo de Usuarios (CSV)</h2>
                            <p class="text-sm text-gray-600 mb-4">Exporta o importa la lista completa de usuarios de la aplicación.</p>
                            <div class="flex space-x-4">
                                <button onclick="exportUsersToCSV()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">Exportar Usuarios</button>
                                <button onclick="openImportModal('users')" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg">Importar Usuarios</button>
                            </div>
                        </div>
                    </div>
                    <!-- Columna Derecha -->
                    <div>
                        <!-- Gestión de Títulos de Login -->
                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h2 class="text-lg font-bold mb-4">Personalizar Pantalla de Login</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="loginTitleInput" class="block text-sm font-medium text-gray-700">Título Principal</label>
                                    <input type="text" id="loginTitleInput" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="loginSubtitleInput" class="block text-sm font-medium text-gray-700">Subtítulo</label>
                                    <input type="text" id="loginSubtitleInput" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="text-right mt-4">
                                <button onclick="saveLoginTitles()" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg">Guardar Títulos</button>
                            </div>
                        </div>
                        <!-- Gestión de Períodos Hábiles -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h2 class="text-lg font-bold mb-4">Gestión de Períodos Hábiles</h2>
                            <div class="space-y-4">
                                <div>
                                    <label for="availableYearsInput" class="block text-sm font-medium text-gray-700">Años Disponibles (separados por coma)</label>
                                    <input type="text" id="availableYearsInput" placeholder="Ej: 2025,2024" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="availableMonthsInput" class="block text-sm font-medium text-gray-700">Meses Disponibles (separados por coma)</label>
                                    <input type="text" id="availableMonthsInput" placeholder="Ej: Enero,Febrero,Marzo..." class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div class="text-right mt-4">
                                <button onclick="saveAvailablePeriods()" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg">Guardar Períodos</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Vista SUPERVISOR -->
        <div id="supervisorScreen" class="hidden h-screen flex flex-col">
            <!-- Header -->
            <header class="bg-white shadow-md p-4 flex justify-between items-center z-10 flex-shrink-0">
                 <div class="flex items-center space-x-3">
                    <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="Logo CNCI" class="h-10 w-auto">
                    <h1 class="text-xl font-bold text-gray-800">🧑‍🏫 Panel de Supervisor</h1>
                </div>
                 <div class="flex items-center space-x-4">
                     <div id="supervisorSyncIndicator" class="text-xs text-gray-500 flex items-center space-x-1">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span>Sincronizado</span>
                    </div>
                    <span id="supervisorWelcome" class="text-sm font-medium text-gray-700"></span>
                    <button onclick="logout()" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Salir</button>
                </div>
            </header>
             <!-- Contenido -->
            <main class="flex-grow p-6 overflow-y-auto bg-gray-50">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Columna de Asesores y Respaldo -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                 <h2 class="text-lg font-bold">Mis Asesores</h2>
                                 <button onclick="openAddAsesorModal()" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg text-sm">Añadir Asesor</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="asesoresTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Centro de Respaldo para Supervisor -->
                        <div class="bg-white rounded-lg shadow-lg p-6">
                            <h2 class="text-lg font-bold mb-4">Respaldo de Evaluaciones (CSV)</h2>
                            <p class="text-sm text-gray-600 mb-4">Exporta o importa las evaluaciones de tus asesores. El formato se basará en tu plantilla actual.</p>
                            <div class="flex space-x-4">
                                <button onclick="exportSupervisorEvaluationsToCSV()" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">Exportar</button>
                                <button onclick="openImportModal('evaluations')" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg">Importar</button>
                            </div>
                        </div>
                    </div>
                    <!-- Columna de Plantillas -->
                    <div class="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold">Plantilla de Evaluación</h2>
                            <button onclick="openCategoryModal()" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Añadir Categoría</button>
                        </div>
                        <div id="categoriesContainer" class="space-y-4">
                           <!-- Las categorías de la plantilla se cargarán aquí -->
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Vista ASESOR -->
        <div id="asesorScreen" class="hidden h-screen flex flex-col">
            <!-- Header -->
            <header class="bg-white shadow-md p-4 flex justify-between items-center z-10 flex-shrink-0">
                <div class="flex items-center space-x-3">
                    <img src="https://i.postimg.cc/KzxV7m0Z/CNCI-VIRTUAL-LOGO.jpg" alt="Logo CNCI" class="h-10 w-auto">
                    <h1 class="text-xl font-bold text-gray-800">👨‍🎓 Dashboard de Desempeño</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <select id="monthSelector" class="rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                        <select id="yearSelector" class="rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                    </div>
                    <span id="asesorWelcome" class="text-sm font-medium text-gray-700"></span>
                    <button onclick="logout()" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Salir</button>
                </div>
            </header>
             <!-- Contenido -->
            <main id="asesorMainContent" class="flex-grow p-6 overflow-y-auto bg-gray-50">
                <!-- Tabs -->
                <div class="mb-6 border-b border-gray-200">
                    <nav class="flex space-x-8" aria-label="Tabs">
                        <button onclick="switchAsesorTab('resumen')" class="asesor-tab whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">Resumen General</button>
                        <button onclick="switchAsesorTab('insignias')" class="asesor-tab whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Insignias</button>
                        <button onclick="switchAsesorTab('plan')" class="asesor-tab whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Plan de Trabajo</button>
                    </nav>
                </div>
                
                <!-- Contenedor de Pestañas -->
                <div id="asesorTabContent">
                    <!-- Pestaña Resumen -->
                    <div id="resumen-tab"></div>
                    <!-- Pestaña Insignias -->
                    <div id="insignias-tab" class="hidden"></div>
                    <!-- Pestaña Plan de Trabajo -->
                    <div id="plan-tab" class="hidden"></div>
                </div>
            </main>
        </div>

    </div> <!-- Fin del #app -->

    <!-- ======================= MODALES ======================= -->
    
    <!-- Modal para Añadir/Editar Usuario (SuperAdmin) -->
    <div id="userModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h3 id="userModalTitle" class="text-xl font-bold mb-4">Añadir Usuario</h3>
            <form id="userForm" class="space-y-4">
                <input type="hidden" id="userId">
                <div>
                    <label class="block text-sm font-medium">Nombre Completo</label>
                    <input type="text" id="userFullName" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Nombre de Usuario</label>
                    <input type="text" id="userUsername" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Contraseña</label>
                    <input type="text" id="userPassword" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Rol</label>
                    <select id="userRole" class="mt-1 w-full border border-gray-300 rounded-lg p-2">
                        <option value="asesor">Asesor</option>
                        <option value="supervisor">Supervisor</option>
                    </select>
                </div>
                <div id="supervisorSelectorContainer">
                    <label class="block text-sm font-medium">Asignar a Supervisor</label>
                    <select id="userSupervisor" class="mt-1 w-full border border-gray-300 rounded-lg p-2"></select>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeUserModal()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Guardar</button>
                    <button type="button" id="deleteUserBtn" onclick="deleteUser()" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hidden">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- NUEVO MODAL: Añadir Asesor (Supervisor) -->
    <div id="addAsesorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h3 class="text-xl font-bold mb-4">Añadir Nuevo Asesor</h3>
            <form id="addAsesorForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">Nombre Completo</label>
                    <input type="text" id="asesorFullName" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Nombre de Usuario</label>
                    <input type="text" id="asesorUsername" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium">Contraseña Inicial</label>
                    <input type="text" id="asesorPassword" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeAddAsesorModal()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Crear Asesor</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Añadir/Editar Categoría (Supervisor) -->
    <div id="categoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h3 id="categoryModalTitle" class="text-xl font-bold mb-4">Añadir Categoría</h3>
            <form id="categoryForm" class="space-y-4">
                <input type="hidden" id="categoryId">
                <div>
                    <label class="block text-sm font-medium">Nombre de la Categoría</label>
                    <input type="text" id="categoryName" class="mt-1 w-full border border-gray-300 rounded-lg p-2" required>
                </div>
                <div>
                    <h4 class="text-sm font-medium mb-2">Criterios de Evaluación</h4>
                    <div id="criteriaInputs" class="space-y-2"></div>
                    <button type="button" onclick="addCriterionInput()" class="mt-2 text-sm text-blue-600 hover:underline">+ Añadir criterio</button>
                </div>
                 <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeCategoryModal()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Evaluación (Supervisor) -->
    <div id="evaluationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 modal-container">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                 <h3 id="evaluationModalTitle" class="text-xl font-bold">Evaluando a...</h3>
                 <button onclick="closeEvaluationModal()" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <form id="evaluationForm" class="space-y-6">
                    <input type="hidden" id="evaluationAsesorId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                       <div>
                            <label class="block text-sm font-medium">Mes</label>
                            <select id="evaluationMonth" class="mt-1 w-full border border-gray-300 rounded-lg p-2"></select>
                       </div>
                       <div>
                            <label class="block text-sm font-medium">Año</label>
                            <select id="evaluationYear" class="mt-1 w-full border border-gray-300 rounded-lg p-2"></select>
                       </div>
                    </div>
                    <!-- Contenedor para las categorías a evaluar -->
                    <div id="evaluationCategoriesContainer" class="space-y-4"></div>
                </form>
            </div>
            <div class="p-6 border-t flex justify-end space-x-3">
                <button type="button" onclick="closeEvaluationModal()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                <button type="button" onclick="saveEvaluation()" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Guardar Evaluación</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h3 id="confirmModalTitle" class="text-lg font-bold mb-2">Confirmar Acción</h3>
            <p id="confirmModalText" class="text-gray-600 mb-6">¿Estás seguro?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg">Cancelar</button>
                <button id="confirmOkBtn" class="bg-red-500 text-white font-semibold py-2 px-6 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Importación/Exportación -->
    <div id="importExportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 id="importExportTitle" class="text-xl font-bold mb-4">Importar Datos</h3>
            <form id="importForm" class="space-y-4">
                 <input type="hidden" id="importDataType">
                <div>
                    <label class="block text-sm font-medium">Archivo CSV</label>
                    <input type="file" id="csvFileInput" accept=".csv" class="mt-1 w-full text-sm text-gray-500
                      file:mr-4 file:py-2 file:px-4
                      file:rounded-full file:border-0
                      file:text-sm file:font-semibold
                      file:bg-blue-50 file:text-blue-700
                      hover:file:bg-blue-100" required/>
                </div>
                 <div class="flex items-start">
                    <div class="flex items-center h-5">
                      <input id="overwriteDataCheckbox" type="checkbox" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                    </div>
                    <div class="ml-3 text-sm">
                      <label for="overwriteDataCheckbox" class="font-medium text-gray-700">Sobrescribir datos existentes</label>
                      <p class="text-gray-500">Si se marca, los datos del CSV reemplazarán los datos existentes con el mismo ID.</p>
                    </div>
                  </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeImportModal()" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Importar</button>
                </div>
            </form>
        </div>
    </div>


    <!-- SCRIPT PRINCIPAL DE LA APLICACIÓN -->
    <script type="module">
        // Importar funciones de Firebase 9+ (versión modular)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Configuración de Firebase (proporcionada por el usuario)
        const firebaseConfig = {
            apiKey: "AIzaSyDApFuzCg6bxKNniw7mTzcZAeAbwOV1mgY",
            authDomain: "appevaluacionse.firebaseapp.com",
            projectId: "appevaluacionse",
            storageBucket: "appevaluacionse.appspot.com",
            messagingSenderId: "52140253389",
            appId: "1:52140253389:web:80fa2267b27d3472d78984",
            measurementId: "G-QFHR58RGH8"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables de estado globales
        let currentUser = null;
        let usersCache = {};
        let supervisorsCache = [];
        let availablePeriods = {
            years: [],
            months: []
        };

        // ======================= INICIALIZACIÓN DE LA APP =======================
        
        window.onload = async () => {
            const loadingStatus = document.getElementById('loadingStatus');
            try {
                await getDoc(doc(db, "system", "health_check"));
                loadingStatus.textContent = 'Conexión exitosa. Inicializando datos...';
                await initializeDataIfNeeded();
                await loadAvailablePeriods();
                loadingStatus.textContent = '¡Listo para iniciar!';
                
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('loginScreen').classList.add('flex');
                    document.getElementById('loginScreen').classList.remove('hidden');
                }, 500);

            } catch (error) {
                loadingStatus.textContent = 'Error al conectar con Firebase. Revisa la consola.';
                console.error("Firebase connection error:", error);
            }
        };

        // ======================= LÓGICA DE LOGIN Y NAVEGACIÓN =======================

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            const loginSpinner = document.getElementById('loginSpinner');
            
            errorDiv.classList.add('hidden');
            loginButton.disabled = true;
            loginButtonText.textContent = 'Verificando...';
            loginSpinner.classList.remove('hidden');

            try {
                const userDoc = await getDoc(doc(db, "users", username));
                if (userDoc.exists() && userDoc.data().password === password) {
                    currentUser = { id: userDoc.id, ...userDoc.data() };
                    navigateToRoleScreen(currentUser.rol);
                } else {
                    errorDiv.textContent = 'Usuario o contraseña incorrectos.';
                    errorDiv.classList.remove('hidden');
                }
            } catch (err) {
                errorDiv.textContent = 'Error al intentar iniciar sesión.';
                errorDiv.classList.remove('hidden');
                console.error(err);
            } finally {
                loginButton.disabled = false;
                loginButtonText.textContent = 'Ingresar';
                loginSpinner.classList.add('hidden');
            }
        });

        async function navigateToRoleScreen(role) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('flex');
            
            await loadUsersCache();
            await loadAvailablePeriods();

            if (role === 'superadmin') {
                document.getElementById('superAdminWelcome').textContent = `Hola, ${currentUser.nombre}`;
                document.getElementById('superAdminScreen').classList.remove('hidden');
                loadSuperAdminView();
            } else if (role === 'supervisor') {
                document.getElementById('supervisorWelcome').textContent = `Hola, ${currentUser.nombre}`;
                document.getElementById('supervisorScreen').classList.remove('hidden');
                loadSupervisorView();
            } else if (role === 'asesor') {
                document.getElementById('asesorWelcome').textContent = `Hola, ${currentUser.nombre}`;
                document.getElementById('asesorScreen').classList.remove('hidden');
                loadAsesorView();
            }
        }

        function logout() {
            currentUser = null;
            ['superAdminScreen', 'supervisorScreen', 'asesorScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById('loginScreen').classList.add('flex');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginForm').reset();
        }

        // ======================= VISTA SUPERADMIN =======================
        
        async function loadSuperAdminView() {
            renderUsersTable();
            const configDoc = await getDoc(doc(db, "system", "config"));
            if (configDoc.exists()) {
                const configData = configDoc.data();
                document.getElementById('loginTitleInput').value = configData.loginTitle || 'Evaluación Modular';
                document.getElementById('loginSubtitleInput').value = configData.loginSubtitle || 'Consulta tu desempeño.';
                document.getElementById('availableYearsInput').value = configData.availableYears?.join(', ') || '';
                document.getElementById('availableMonthsInput').value = configData.availableMonths?.join(', ') || '';
            }
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            Object.values(usersCache).sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${user.nombre}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.rol === 'supervisor' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">${user.rol}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.supervisorAsignado ? usersCache[user.supervisorAsignado]?.nombre || 'N/A' : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="openUserModal('${user.id}')" class="text-indigo-600 hover:text-indigo-900">Editar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function openUserModal(userId = null) {
            const form = document.getElementById('userForm');
            form.reset();
            document.getElementById('supervisorSelectorContainer').style.display = 'block';
            document.getElementById('deleteUserBtn').classList.add('hidden');

            const supervisorSelect = document.getElementById('userSupervisor');
            supervisorSelect.innerHTML = '<option value="">Ninguno</option>';
            supervisorsCache.forEach(sup => {
                supervisorSelect.innerHTML += `<option value="${sup.id}">${sup.nombre}</option>`;
            });
            
            if (userId) {
                const user = usersCache[userId];
                document.getElementById('userModalTitle').textContent = 'Editar Usuario';
                document.getElementById('userId').value = user.id;
                document.getElementById('userFullName').value = user.nombre;
                document.getElementById('userUsername').value = user.id;
                document.getElementById('userUsername').disabled = true;
                document.getElementById('userPassword').value = user.password;
                document.getElementById('userRole').value = user.rol;
                if (user.rol === 'asesor') {
                    supervisorSelect.value = user.supervisorAsignado || '';
                }
                document.getElementById('supervisorSelectorContainer').style.display = user.rol === 'asesor' ? 'block' : 'none';
                document.getElementById('deleteUserBtn').classList.remove('hidden');

            } else {
                document.getElementById('userModalTitle').textContent = 'Añadir Usuario';
                document.getElementById('userId').value = ''; 
                document.getElementById('userUsername').disabled = false;
            }
            document.getElementById('userModal').classList.remove('hidden');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }
        
        document.getElementById('userRole').addEventListener('change', (e) => {
            document.getElementById('supervisorSelectorContainer').style.display = e.target.value === 'asesor' ? 'block' : 'none';
        });

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('userUsername').value.trim();
            
            if(!username){
                alert("El nombre de usuario es obligatorio.");
                return;
            }

            if (!userId) {
                const userExists = await getDoc(doc(db, "users", username));
                if(userExists.exists()){
                    alert("Este nombre de usuario ya existe. Por favor, elige otro.");
                    return;
                }
            }

            const userData = {
                nombre: document.getElementById('userFullName').value,
                password: document.getElementById('userPassword').value,
                rol: document.getElementById('userRole').value,
                supervisorAsignado: document.getElementById('userRole').value === 'asesor' ? document.getElementById('userSupervisor').value : null
            };
            
            const docId = userId || username;
            
            await setDoc(doc(db, "users", docId), userData);
            showSyncIndicator('superAdminSyncIndicator');
            closeUserModal();
            await loadUsersCache();
            renderUsersTable();
        });
        
        function deleteUser() {
             const userId = document.getElementById('userId').value;
             showConfirmModal('Eliminar Usuario', `¿Estás seguro de que quieres eliminar a ${userId}?`, async () => {
                await deleteDoc(doc(db, "users", userId));
                showSyncIndicator('superAdminSyncIndicator');
                closeUserModal();
                await loadUsersCache();
                renderUsersTable();
            });
        }
        
        async function saveLoginTitles() {
            const title = document.getElementById('loginTitleInput').value;
            const subtitle = document.getElementById('loginSubtitleInput').value;
            await setDoc(doc(db, "system", "config"), { loginTitle: title, loginSubtitle: subtitle }, { merge: true });
            showSyncIndicator('superAdminSyncIndicator');
            alert('Títulos guardados.');
        }

        async function saveAvailablePeriods() {
            const years = document.getElementById('availableYearsInput').value.split(',').map(y => y.trim()).filter(Boolean);
            const months = document.getElementById('availableMonthsInput').value.split(',').map(m => m.trim()).filter(Boolean);
            
            await setDoc(doc(db, "system", "config"), { availableYears: years, availableMonths: months }, { merge: true });
            await loadAvailablePeriods(); 
            showSyncIndicator('superAdminSyncIndicator');
            alert('Períodos hábiles guardados.');
        }

        // ======================= VISTA SUPERVISOR =======================

        async function loadSupervisorView() {
            renderAsesoresTable();
            await renderCategoryManagement();
        }

        function renderAsesoresTable() {
            const tbody = document.getElementById('asesoresTableBody');
            tbody.innerHTML = '';
            const misAsesores = Object.values(usersCache).filter(u => u.supervisorAsignado === currentUser.id);
            if (misAsesores.length === 0) {
                tbody.innerHTML = `<tr><td colspan="2" class="text-center text-gray-500 py-4">No tienes asesores asignados.</td></tr>`;
                return;
            }
            misAsesores.forEach(asesor => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-2">${asesor.nombre}</td>
                    <td class="px-4 py-2">
                        <button onclick="openEvaluationModal('${asesor.id}')" class="text-indigo-600 hover:text-indigo-900 text-sm">Evaluar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openAddAsesorModal() {
            document.getElementById('addAsesorForm').reset();
            document.getElementById('addAsesorModal').classList.remove('hidden');
        }

        function closeAddAsesorModal() {
            document.getElementById('addAsesorModal').classList.add('hidden');
        }
        
        document.getElementById('addAsesorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('asesorUsername').value.trim();
            if (!username) {
                alert("El nombre de usuario es obligatorio.");
                return;
            }
            const userExists = await getDoc(doc(db, "users", username));
            if(userExists.exists()) {
                alert("Este nombre de usuario ya existe. Por favor, elige otro.");
                return;
            }

            const newAsesorData = {
                nombre: document.getElementById('asesorFullName').value,
                password: document.getElementById('asesorPassword').value,
                rol: 'asesor',
                supervisorAsignado: currentUser.id
            };
            
            await setDoc(doc(db, "users", username), newAsesorData);
            showSyncIndicator('supervisorSyncIndicator');
            closeAddAsesorModal();
            await loadUsersCache();
            renderAsesoresTable();
        });


        async function renderCategoryManagement() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '<div class="skeleton h-24 w-full"></div>';
            const templateDoc = await getDoc(doc(db, "evaluation_templates", currentUser.id));
            const template = templateDoc.exists() ? templateDoc.data().categorias : [];
            container.innerHTML = '';

            if (template.length === 0) {
                container.innerHTML = `<p class="text-gray-500">Aún no has creado categorías para tu plantilla de evaluación.</p>`;
            } else {
                template.forEach((cat, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-4 border rounded-lg';
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold">${cat.nombre}</h4>
                            <div>
                                <button onclick="openCategoryModal(${index})" class="text-indigo-600 text-sm mr-2">Editar</button>
                                <button onclick="deleteCategory(${index})" class="text-red-600 text-sm">Eliminar</button>
                            </div>
                        </div>
                        <ul class="list-disc list-inside mt-2 text-sm text-gray-600">
                            ${cat.criterios.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    `;
                    container.appendChild(div);
                });
            }
        }

        async function openCategoryModal(index = null) {
            const form = document.getElementById('categoryForm');
            form.reset();
            document.getElementById('criteriaInputs').innerHTML = '';

            if (index !== null) {
                const templateDoc = await getDoc(doc(db, "evaluation_templates", currentUser.id));
                const category = templateDoc.data().categorias[index];
                document.getElementById('categoryModalTitle').textContent = 'Editar Categoría';
                document.getElementById('categoryId').value = index;
                document.getElementById('categoryName').value = category.nombre;
                category.criterios.forEach(c => addCriterionInput(c));
            } else {
                document.getElementById('categoryModalTitle').textContent = 'Añadir Categoría';
                addCriterionInput();
            }

            document.getElementById('categoryModal').classList.remove('hidden');
        };
        
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.add('hidden');
        }
        
        function addCriterionInput(value = '') {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.innerHTML = `
                <input type="text" class="w-full border border-gray-300 rounded-lg p-2" value="${value}" required>
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500">&times;</button>
            `;
            document.getElementById('criteriaInputs').appendChild(div);
        }

        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const index = document.getElementById('categoryId').value;
            const newCategory = {
                nombre: document.getElementById('categoryName').value,
                criterios: [...document.querySelectorAll('#criteriaInputs input')].map(input => input.value).filter(val => val)
            };
            
            const templateRef = doc(db, "evaluation_templates", currentUser.id);
            const templateDoc = await getDoc(templateRef);
            let categorias = templateDoc.exists() && Array.isArray(templateDoc.data().categorias) ? templateDoc.data().categorias : [];

            if (index) {
                categorias[parseInt(index)] = newCategory;
            } else {
                categorias.push(newCategory);
            }

            await setDoc(templateRef, { categorias });
            showSyncIndicator('supervisorSyncIndicator');
            closeCategoryModal();
            renderCategoryManagement();
        });

        async function deleteCategory(index) {
            showConfirmModal('Eliminar Categoría', '¿Estás seguro?', async () => {
                const templateRef = doc(db, "evaluation_templates", currentUser.id);
                const templateDoc = await getDoc(templateRef);
                let categorias = templateDoc.data().categorias;
                categorias.splice(index, 1);
                await setDoc(templateRef, { categorias });
                showSyncIndicator('supervisorSyncIndicator');
                renderCategoryManagement();
            });
        };

        // ======================= LÓGICA DE EVALUACIÓN (SUPERVISOR) =======================
        
        async function openEvaluationModal(asesorId) {
            document.getElementById('evaluationModalTitle').textContent = `Evaluando a ${usersCache[asesorId].nombre}`;
            document.getElementById('evaluationAsesorId').value = asesorId;
            
            const monthSelect = document.getElementById('evaluationMonth');
            const yearSelect = document.getElementById('evaluationYear');
            const currentMonthName = new Date().toLocaleString('es-ES', { month: 'long' });
            
            monthSelect.innerHTML = availablePeriods.months.map(m => `<option value="${m}" ${m.toLowerCase() === currentMonthName.toLowerCase() ? 'selected' : ''}>${m}</option>`).join('');
            yearSelect.innerHTML = availablePeriods.years.map(y => `<option value="${y}">${y}</option>`).join('');
            
            await loadEvaluationFormData();

            document.getElementById('evaluationModal').classList.remove('hidden');
        };

        const loadEvaluationFormData = async () => {
            const asesorId = document.getElementById('evaluationAsesorId').value;
            const month = document.getElementById('evaluationMonth').value;
            const year = document.getElementById('evaluationYear').value;
            const container = document.getElementById('evaluationCategoriesContainer');
            container.innerHTML = '<div class="skeleton h-48 w-full"></div>';

            const templateDoc = await getDoc(doc(db, "evaluation_templates", currentUser.id));
            if (!templateDoc.exists() || !templateDoc.data().categorias) {
                container.innerHTML = '<p class="text-red-500">Error: No se encontró tu plantilla de evaluación. Por favor, crea una primero.</p>';
                return;
            }
            const template = templateDoc.data().categorias;

            const evalId = `${asesorId}_${year}_${month}`;
            const evalDoc = await getDoc(doc(db, "evaluations", evalId));
            const existingData = evalDoc.exists() ? evalDoc.data() : {};
            
            container.innerHTML = '';
            
            container.innerHTML += `
                <div class="p-4 border rounded-lg bg-gray-50">
                    <h4 class="font-bold mb-2">Resumen General y Enlaces</h4>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                           <label class="block text-sm font-medium">Calificación General (0-10)</label>
                           <input type="number" id="evalGeneralScore" min="0" max="10" step="0.1" value="${existingData.calificacionGeneral || ''}" class="mt-1 w-full p-2 border rounded-lg">
                        </div>
                         <div>
                           <label class="block text-sm font-medium">Meta de Llamadas (%)</label>
                           <input type="number" id="evalCallsTarget" min="0" max="100" value="${existingData.metaLlamadas || ''}" class="mt-1 w-full p-2 border rounded-lg">
                        </div>
                         <div>
                           <label class="block text-sm font-medium">Enlace "Detalles de Evaluación"</label>
                           <input type="url" id="evalDetailsLink" value="${existingData.enlaceDetalles || ''}" class="mt-1 w-full p-2 border rounded-lg">
                        </div>
                         <div>
                           <label class="block text-sm font-medium">Enlace "Crear Plan de Trabajo"</label>
                           <input type="url" id="evalWorkPlanLink" value="${existingData.enlacePlanTrabajo || ''}" class="mt-1 w-full p-2 border rounded-lg">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium">Comentarios Generales</label>
                        <textarea id="evalGeneralComments" rows="3" class="mt-1 w-full p-2 border rounded-lg">${existingData.comentariosGenerales || ''}</textarea>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium">Texto para "Plan de Trabajo"</label>
                        <textarea id="evalWorkPlanText" rows="3" class="mt-1 w-full p-2 border rounded-lg">${existingData.textoPlanTrabajo || ''}</textarea>
                    </div>
                </div>
            `;
            
            template.forEach(cat => {
                const catData = existingData.categoriasEvaluadas ? existingData.categoriasEvaluadas[cat.nombre] || {} : {};
                const criteriaHTML = cat.criterios.map(crit => `
                     <div class="grid grid-cols-3 gap-2 items-center">
                        <label class="text-sm col-span-2">${crit}</label>
                        <input type="number" min="0" max="10" data-category="${cat.nombre}" data-criterion="${crit}" value="${catData.criterios ? catData.criterios[crit] || '' : ''}" class="criterion-score w-full p-1 border rounded-lg text-center">
                     </div>
                `).join('');

                container.innerHTML += `
                    <div class="p-4 border rounded-lg">
                        <h4 class="font-bold">${cat.nombre}</h4>
                        <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">${criteriaHTML}</div>
                            <div>
                                <label class="block text-sm font-medium">Comentarios (Calidad)</label>
                                <textarea data-category="${cat.nombre}" name="comment_calidad" rows="2" class="mt-1 w-full p-2 border rounded-lg">${catData.comentarioCalidad || ''}</textarea>
                                <label class="block text-sm font-medium mt-2">Comentarios (Supervisión)</label>
                                <textarea data-category="${cat.nombre}" name="comment_supervision" rows="2" class="mt-1 w-full p-2 border rounded-lg">${catData.comentarioSupervision || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            });
        };

        document.getElementById('evaluationMonth').addEventListener('change', loadEvaluationFormData);
        document.getElementById('evaluationYear').addEventListener('change', loadEvaluationFormData);

        function closeEvaluationModal() {
            document.getElementById('evaluationModal').classList.add('hidden');
        }
        
        async function saveEvaluation() {
            const asesorId = document.getElementById('evaluationAsesorId').value;
            const month = document.getElementById('evaluationMonth').value;
            const year = document.getElementById('evaluationYear').value;
            const evalId = `${asesorId}_${year}_${month}`;
            
            const evaluationData = {
                asesorId, month, year, supervisorId: currentUser.id,
                calificacionGeneral: document.getElementById('evalGeneralScore').value,
                metaLlamadas: document.getElementById('evalCallsTarget').value,
                enlaceDetalles: document.getElementById('evalDetailsLink').value,
                enlacePlanTrabajo: document.getElementById('evalWorkPlanLink').value,
                comentariosGenerales: document.getElementById('evalGeneralComments').value,
                textoPlanTrabajo: document.getElementById('evalWorkPlanText').value,
                categoriasEvaluadas: {}
            };

            const templateDoc = await getDoc(doc(db, "evaluation_templates", currentUser.id));
            if (!templateDoc.exists()) {
                alert("Error: No se encontró la plantilla de evaluación.");
                return;
            }
            const templateCategories = templateDoc.data().categorias;

            templateCategories.forEach(cat => {
                const catName = cat.nombre;
                const catData = {
                    criterios: {},
                    puntaje: 0,
                    comentarioCalidad: '',
                    comentarioSupervision: ''
                };
                
                let totalScore = 0;
                let scoreCount = 0;

                cat.criterios.forEach(critName => {
                    const input = document.querySelector(`input[data-category="${catName}"][data-criterion="${critName}"]`);
                    if (input && input.value !== '') {
                        const score = parseFloat(input.value);
                        if (!isNaN(score)) {
                            catData.criterios[critName] = score;
                            totalScore += score;
                            scoreCount++;
                        }
                    }
                });

                if (scoreCount > 0) {
                    catData.puntaje = (totalScore / scoreCount).toFixed(2);
                }

                const commentCalidad = document.querySelector(`textarea[data-category="${catName}"][name="comment_calidad"]`);
                if (commentCalidad) catData.comentarioCalidad = commentCalidad.value;
                
                const commentSupervision = document.querySelector(`textarea[data-category="${catName}"][name="comment_supervision"]`);
                if (commentSupervision) catData.comentarioSupervision = commentSupervision.value;

                evaluationData.categoriasEvaluadas[catName] = catData;
            });

            try {
                await setDoc(doc(db, "evaluations", evalId), evaluationData);
                showSyncIndicator('supervisorSyncIndicator');
                closeEvaluationModal();
                alert('Evaluación guardada exitosamente.');
            } catch(error) {
                console.error("Error al guardar evaluación:", error);
                alert('Hubo un error al guardar la evaluación.');
            }
        };


        // ======================= VISTA ASESOR =======================

        async function loadAsesorView() {
            const monthSelect = document.getElementById('monthSelector');
            const yearSelect = document.getElementById('yearSelector');
            const currentMonthName = new Date().toLocaleString('es-ES', { month: 'long' });

            monthSelect.innerHTML = availablePeriods.months.map(m => `<option value="${m}" ${m.toLowerCase() === currentMonthName.toLowerCase() ? 'selected' : ''}>${m}</option>`).join('');
            yearSelect.innerHTML = availablePeriods.years.map(y => `<option value="${y}">${y}</option>`).join('');

            monthSelect.addEventListener('change', renderAsesorDashboard);
            yearSelect.addEventListener('change', renderAsesorDashboard);
            
            renderAsesorDashboard();
        }

        function switchAsesorTab(tabName) {
            document.querySelectorAll('#asesorTabContent > div').forEach(div => div.classList.add('hidden'));
            document.querySelectorAll('.asesor-tab').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            const activeTab = document.getElementById(`${tabName}-tab`);
            activeTab.classList.remove('hidden');
            const button = document.querySelector(`.asesor-tab[onclick="switchAsesorTab('${tabName}')"]`);
            button.classList.add('border-blue-500', 'text-blue-600');
            button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        };

        async function renderAsesorDashboard() {
            const month = document.getElementById('monthSelector').value;
            const year = document.getElementById('yearSelector').value;
            const evalId = `${currentUser.id}_${year}_${month}`;
            const resumenContainer = document.getElementById('resumen-tab');
            const insigniasContainer = document.getElementById('insignias-tab');
            const planContainer = document.getElementById('plan-tab');

            resumenContainer.innerHTML = '<div class="skeleton h-64 w-full"></div>';
            insigniasContainer.innerHTML = ''; 
            planContainer.innerHTML = '';

            try {
                const evalDoc = await getDoc(doc(db, "evaluations", evalId));
            
                if (!evalDoc.exists()) {
                    resumenContainer.innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow-lg"><h3 class="text-xl font-bold">Sin Evaluación</h3><p class="text-gray-600 mt-2">Aún no se ha cargado tu evaluación para ${month} de ${year}.</p></div>`;
                    return;
                }

                const data = evalDoc.data();
                
                let categoriesHTML = '';
                if (data.categoriasEvaluadas) {
                    for (const catName in data.categoriasEvaluadas) {
                        const catData = data.categoriasEvaluadas[catName];
                        const score = parseFloat(catData.puntaje || 0);
                        const scoreClass = score >= 9 ? 'score-high' : score >= 7 ? 'score-medium' : 'score-low';

                        // MODIFICACIÓN: Crear lista de criterios
                        let criteriaHTMLList = '<p class="text-xs text-gray-500">No se evaluaron criterios específicos.</p>';
                        if (catData.criterios && Object.keys(catData.criterios).length > 0) {
                            criteriaHTMLList = Object.entries(catData.criterios).map(([critName, critScore]) => `
                                <li class="flex justify-between items-center py-1 border-b border-gray-100">
                                    <span class="text-gray-600">${critName}</span>
                                    <span class="font-bold text-gray-800">${critScore}/10</span>
                                </li>
                            `).join('');
                            criteriaHTMLList = `<ul class="space-y-1 mt-2">${criteriaHTMLList}</ul>`;
                        }

                        categoriesHTML += `
                            <div class="bg-white rounded-lg shadow p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-lg">${catName}</h4>
                                    <div class="score-circle ${scoreClass}">${score.toFixed(1)}</div>
                                </div>
                                <div class="text-sm space-y-2">
                                    <p><strong>Comentarios de Calidad:</strong> ${catData.comentarioCalidad || 'N/A'}</p>
                                    <p><strong>Comentarios de Supervisión:</strong> ${catData.comentarioSupervision || 'N/A'}</p>
                                </div>
                                <!-- NUEVA SECCIÓN PARA CRITERIOS -->
                                <div class="mt-4">
                                    <button onclick="toggleCriteria(this)" class="flex items-center text-sm text-blue-600 font-semibold">
                                        <span>Ver Criterios</span>
                                        <svg class="w-4 h-4 ml-1 criteria-toggle" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </button>
                                    <div class="hidden mt-2 text-sm">
                                        ${criteriaHTMLList}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                const calificacionGeneral = data.calificacionGeneral || 0;
                const metaLlamadas = data.metaLlamadas || 0;

                resumenContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow p-4">
                            <h3 class="font-bold mb-2">Calificación General</h3>
                            <div class="progress-bar-container"><div class="progress-bar h-4" style="width: ${calificacionGeneral * 10}%"></div></div>
                            <p class="text-right font-bold mt-1">${calificacionGeneral} / 10</p>
                        </div>
                        <div class="bg-white rounded-lg shadow p-4">
                            <h3 class="font-bold mb-2">Meta de Llamadas</h3>
                            <div class="progress-bar-container"><div class="progress-bar h-4" style="width: ${metaLlamadas}%"></div></div>
                            <p class="text-right font-bold mt-1">${metaLlamadas}%</p>
                        </div>
                    </div>
                    <div class="space-y-4 mb-6">${categoriesHTML}</div>
                    <div class="bg-white rounded-lg shadow p-4">
                         <h3 class="font-bold mb-2">Comentarios Generales del Supervisor</h3>
                         <p class="text-sm text-gray-700">${data.comentariosGenerales || 'Sin comentarios generales.'}</p>
                    </div>
                    <div class="mt-6 text-center">
                        <a href="${data.enlaceDetalles || '#'}" target="_blank" class="btn-primary inline-block text-white font-semibold py-2 px-6 rounded-lg">Detalles de Evaluación</a>
                    </div>
                `;
                
                insigniasContainer.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-bold text-xl mb-4">Insignias Obtenidas</h3>
                    <p class="text-gray-500">Esta sección estará disponible en futuras actualizaciones.</p>
                </div>`;
                
                planContainer.innerHTML = `
                     <div class="bg-white rounded-lg shadow p-6 text-center">
                         <h3 class="font-bold text-xl mb-4">Plan de Trabajo</h3>
                         <p class="text-gray-600 mb-6">${data.textoPlanTrabajo || 'Tu supervisor ha preparado un plan de trabajo para ti. Haz clic en el botón para verlo.'}</p>
                         <a href="${data.enlacePlanTrabajo || '#'}" target="_blank" class="btn-secondary inline-block text-white font-semibold py-2 px-6 rounded-lg">Acceder a mi Plan de Trabajo</a>
                     </div>`;
            } catch (error) {
                 console.error("Error renderizando dashboard de asesor:", error);
                 resumenContainer.innerHTML = `<div class="text-center p-10 bg-red-100 text-red-700 rounded-lg shadow-lg"><h3 class="text-xl font-bold">Error al Cargar</h3><p class="mt-2">Hubo un problema al cargar tu evaluación. Por favor, intenta de nuevo más tarde.</p></div>`;
            }
        }
        
        // ======================= HELPERS Y UTILIDADES =======================
        
        async function loadUsersCache() {
            usersCache = {};
            supervisorsCache = [];
            const querySnapshot = await getDocs(collection(db, "users"));
            querySnapshot.forEach((doc) => {
                usersCache[doc.id] = { id: doc.id, ...doc.data() };
                if (doc.data().rol === 'supervisor') {
                    supervisorsCache.push({ id: doc.id, ...doc.data() });
                }
            });
        }

        function showConfirmModal(title, text, onConfirm) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalText').textContent = text;
            const confirmBtn = document.getElementById('confirmOkBtn');
            const cancelBtn = document.getElementById('confirmCancelBtn');
            
            const newConfirmBtn = confirmBtn.cloneNode(true); 
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => {
                onConfirm();
                document.getElementById('confirmModal').classList.add('hidden');
            });
            cancelBtn.onclick = () => document.getElementById('confirmModal').classList.add('hidden');

            document.getElementById('confirmModal').classList.remove('hidden');
        }
        
        function showSyncIndicator(elementId) {
            const indicator = document.getElementById(elementId);
            if (indicator) {
                indicator.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-yellow-500 animate-ping absolute"></div>
                    <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                    <span class="ml-1">Guardando...</span>`;
                setTimeout(() => {
                    indicator.innerHTML = `
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span>Sincronizado</span>`;
                }, 1500);
            }
        }

        async function loadAvailablePeriods() {
            const configDoc = await getDoc(doc(db, "system", "config"));
            if (configDoc.exists()) {
                const data = configDoc.data();
                availablePeriods.years = data.availableYears || [new Date().getFullYear().toString()];
                availablePeriods.months = data.availableMonths || ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            }
        }
        
        // NUEVA FUNCIÓN PARA DESPLEGAR CRITERIOS EN DASHBOARD DE ASESOR
        function toggleCriteria(button) {
            const criteriaContent = button.nextElementSibling;
            const icon = button.querySelector('svg');
            const buttonText = button.querySelector('span');

            const isHidden = criteriaContent.classList.toggle('hidden');
            icon.classList.toggle('rotated', !isHidden);
            
            buttonText.textContent = isHidden ? 'Ver Criterios' : 'Ocultar Criterios';
        }

        async function initializeDataIfNeeded() {
            const configRef = doc(db, "system", "config");
            const configDoc = await getDoc(configRef);

            if (!configDoc.exists()) {
                console.log("No initial config found. Creating defaults...");
                const batch = writeBatch(db);
                
                batch.set(doc(db, "users", "superadmin"), {
                    nombre: "Super Administrador",
                    password: "123",
                    rol: "superadmin"
                });

                batch.set(configRef, {
                    loginTitle: "Evaluación Modular",
                    loginSubtitle: "Departamento de Servicios Estudiantiles",
                    availableYears: ["2025", "2024"],
                    availableMonths: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]
                });
                
                await batch.commit();
                console.log("Default config and SuperAdmin created.");
            }
        }
        
        // ======================= LÓGICA DE IMPORTACIÓN/EXPORTACIÓN CSV =======================
        function openImportModal(type) {
            document.getElementById('importDataType').value = type;
            document.getElementById('importForm').reset();
            const title = type === 'users' ? 'Importar Usuarios' : 'Importar Evaluaciones';
            document.getElementById('importExportTitle').textContent = title;
            document.getElementById('importExportModal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('importExportModal').classList.add('hidden');
        }

        async function exportUsersToCSV() {
            const usersSnapshot = await getDocs(collection(db, "users"));
            let csvContent = "username,nombre,rol,password,supervisorAsignado\n";
            usersSnapshot.forEach(doc => {
                const user = doc.data();
                const row = [doc.id, `"${user.nombre}"`, user.rol, user.password, user.supervisorAsignado || ''].join(',');
                csvContent += row + "\n";
            });
            downloadCSV(csvContent, 'usuarios_respaldo.csv');
        }

        async function exportSupervisorEvaluationsToCSV() {
            const templateDoc = await getDoc(doc(db, "evaluation_templates", currentUser.id));
            if (!templateDoc.exists()) {
                alert("No se puede exportar porque no tienes una plantilla de evaluación definida.");
                return;
            }
            const template = templateDoc.data().categorias || [];
            
            let headers = ["evalId", "asesorId", "mes", "año", "calificacionGeneral", "metaLlamadas", "comentariosGenerales", "enlaceDetalles", "enlacePlanTrabajo", "textoPlanTrabajo"];
            template.forEach(cat => {
                cat.criterios.forEach(crit => {
                    headers.push(`${cat.nombre}_${crit}_Puntaje`);
                });
                headers.push(`${cat.nombre}_ComentarioCalidad`, `${cat.nombre}_ComentarioSupervision`);
            });
            
            const q = query(collection(db, "evaluations"), where("supervisorId", "==", currentUser.id));
            const evaluationsSnapshot = await getDocs(q);

            let csvContent = headers.join(',') + '\n';

            evaluationsSnapshot.forEach(doc => {
                const e = doc.data();
                let row = [
                    doc.id, e.asesorId, e.mes, e.año,
                    e.calificacionGeneral || '', e.metaLlamadas || '',
                    `"${(e.comentariosGenerales || '').replace(/"/g, '""')}"`,
                    `"${e.enlaceDetalles || ''}"`,
                    `"${e.enlacePlanTrabajo || ''}"`,
                    `"${(e.textoPlanTrabajo || '').replace(/"/g, '""')}"`
                ];

                template.forEach(cat => {
                    const catData = e.categoriasEvaluadas ? e.categoriasEvaluadas[cat.nombre] || {} : {};
                    cat.criterios.forEach(crit => {
                        const score = catData.criterios ? catData.criterios[crit] || '' : '';
                        row.push(score);
                    });
                    row.push(`"${(catData.comentarioCalidad || '').replace(/"/g, '""')}"`);
                    row.push(`"${(catData.comentarioSupervision || '').replace(/"/g, '""')}"`);
                });
                csvContent += row.join(',') + '\n';
            });

            downloadCSV(csvContent, `evaluaciones_${currentUser.id}_respaldo.csv`);
        }

        function downloadCSV(content, fileName) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.getElementById('importForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('csvFileInput');
            if (fileInput.files.length === 0) {
                alert('Por favor, selecciona un archivo CSV.');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(event) {
                const csvData = event.target.result;
                const dataType = document.getElementById('importDataType').value;
                
                if (dataType === 'users') {
                    await importUsersFromCSV(csvData);
                } else if (dataType === 'evaluations') {
                    await importSupervisorEvaluationsFromCSV(csvData);
                }
            };
            
            reader.readAsText(file);
        });

        async function importUsersFromCSV(csvData) {
            const overwrite = document.getElementById('overwriteDataCheckbox').checked;
            const lines = csvData.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('El archivo CSV está vacío o solo contiene la cabecera.');
                return;
            }
            
            const headers = lines[0].trim().split(',');
            const batch = writeBatch(db);
            let operationsCount = 0;

            try {
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].trim().split(',');
                    const record = headers.reduce((obj, header, index) => {
                        obj[header] = values[index] ? values[index].replace(/"/g, '') : '';
                        return obj;
                    }, {});

                    if (!record.username) continue;
                    const userRef = doc(db, "users", record.username);
                    const userData = {
                        nombre: record.nombre || '',
                        rol: record.rol || 'asesor',
                        password: record.password || '123',
                        supervisorAsignado: record.supervisorAsignado || null
                    };
                    
                    if (overwrite) {
                        batch.set(userRef, userData);
                    } else {
                         // Solo actualiza, no crea nuevos usuarios si no existen
                        batch.update(userRef, userData);
                    }
                    operationsCount++;
                }
                await batch.commit();
                alert(`Se han procesado ${operationsCount} registros de usuarios.`);
                closeImportModal();
                await loadUsersCache();
                renderUsersTable();
            } catch (error) {
                console.error("Error al importar usuarios CSV:", error);
                alert("Error al importar el archivo de usuarios. Revisa la consola.");
            }
        }

        async function importSupervisorEvaluationsFromCSV(csvData) {
            const overwrite = document.getElementById('overwriteDataCheckbox').checked;
            const templateDoc = await getDoc(doc(db, "evaluation_templates", currentUser.id));
             if (!templateDoc.exists()) {
                alert("No se puede importar porque no tienes una plantilla de evaluación definida.");
                return;
            }
            const template = templateDoc.data().categorias || [];
            
            const lines = csvData.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('El archivo CSV de evaluaciones está vacío o solo contiene la cabecera.');
                return;
            }

            const headers = lines[0].trim().split(',');
            const batch = writeBatch(db);
            let operationsCount = 0;

            try {
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].trim().split(',');
                    const record = headers.reduce((obj, header, index) => {
                        obj[header] = values[index] ? values[index].replace(/"/g, '') : '';
                        return obj;
                    }, {});

                    if (!record.evalId && !(record.asesorId && record.año && record.mes)) continue;
                    
                    const evalId = record.evalId || `${record.asesorId}_${record.año}_${record.mes}`;
                    const evalRef = doc(db, "evaluations", evalId);

                    const evalData = {
                        asesorId: record.asesorId, supervisorId: currentUser.id, mes: record.mes, año: record.año,
                        calificacionGeneral: record.calificacionGeneral || '', metaLlamadas: record.metaLlamadas || '',
                        comentariosGenerales: record.comentariosGenerales || '', enlaceDetalles: record.enlaceDetalles || '',
                        enlacePlanTrabajo: record.enlacePlanTrabajo || '', textoPlanTrabajo: record.textoPlanTrabajo || '',
                        categoriasEvaluadas: {}
                    };

                    template.forEach(cat => {
                        const catName = cat.nombre;
                        const catData = { criterios: {}, puntaje: 0, comentarioCalidad: '', comentarioSupervision: '' };
                        let totalScore = 0;
                        let scoreCount = 0;

                        cat.criterios.forEach(crit => {
                            const score = parseFloat(record[`${catName}_${crit}_Puntaje`]);
                            if (!isNaN(score)) {
                                catData.criterios[crit] = score;
                                totalScore += score;
                                scoreCount++;
                            }
                        });
                        
                        if (scoreCount > 0) catData.puntaje = (totalScore / scoreCount).toFixed(2);
                        catData.comentarioCalidad = record[`${catName}_ComentarioCalidad`] || '';
                        catData.comentarioSupervision = record[`${catName}_ComentarioSupervision`] || '';
                        evalData.categoriasEvaluadas[catName] = catData;
                    });
                    
                    if (overwrite) {
                        batch.set(evalRef, evalData);
                    } else {
                        batch.update(evalRef, evalData);
                    }
                    operationsCount++;
                }

                await batch.commit();
                alert(`Se han procesado ${operationsCount} registros de evaluaciones.`);
                closeImportModal();

            } catch(error) {
                console.error("Error al importar evaluaciones CSV:", error);
                alert("Error al importar el archivo de evaluaciones. Revisa la consola y asegúrate que el formato coincida con tu plantilla.");
            }
        }


        // ======================= EXPOSICIÓN DE FUNCIONES GLOBALES =======================
        window.logout = logout;
        window.openUserModal = openUserModal;
        window.closeUserModal = closeUserModal;
        window.deleteUser = deleteUser;
        window.saveLoginTitles = saveLoginTitles;
        window.saveAvailablePeriods = saveAvailablePeriods;
        window.openCategoryModal = openCategoryModal;
        window.closeCategoryModal = closeCategoryModal;
        window.addCriterionInput = addCriterionInput;
        window.deleteCategory = deleteCategory;
        window.openEvaluationModal = openEvaluationModal;
        window.closeEvaluationModal = closeEvaluationModal;
        window.saveEvaluation = saveEvaluation;
        window.switchAsesorTab = switchAsesorTab;
        window.openAddAsesorModal = openAddAsesorModal; 
        window.closeAddAsesorModal = closeAddAsesorModal;
        window.toggleCriteria = toggleCriteria;
        window.openImportModal = openImportModal;
        window.closeImportModal = closeImportModal;
        window.exportUsersToCSV = exportUsersToCSV;
        window.exportSupervisorEvaluationsToCSV = exportSupervisorEvaluationsToCSV;


    </script>
</body>
</html>

